[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|default(60)|float %}
  {% set target_extruder = params.EXTRUDER|default(200)|float %}
  {% set x_center = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_center = printer.toolhead.axis_maximum.y|float / 2 %}

  # --- Shared Y planning (avoid CLEAN/PRIME overlap) ---
  {% set y_min = printer.toolhead.axis_minimum.y|float %}
  {% set clean_yoff = 1.0 %}           # MUST match YOFF passed to CLEAN_NOZZLE
  {% set y_clean = y_min + clean_yoff %}
  {% set prime_sep = 4.0 %}            # mm separation between clean line and prime line
  {% set y_prime = y_min + 2.0 %}      # your preferred prime start (near the front)

  # If prime would be too close to clean line, push it further back
  {% if (y_prime - y_clean) < prime_sep %}
    {% set y_prime = y_clean + prime_sep %}
  {% endif %}

  # [TODO]
  M221 S70

  # --- Safety / state reset ---
  LED_HEATING
  G90
  M83
  G92 E0
  SET_GCODE_OFFSET Z=0
  BED_MESH_CLEAR

  # --- CLEAN NOZZLE ---
  CLEAN_NOZZLE BED=90 NOZZLE=240 COOL_NOZZLE=150 TARGET_BED={target_bed} TARGET_NOZZLE=145 ZWIPE=0.55 WIPE_F=2400 PASSES=2 SNAP=25 YOFF={clean_yoff} MARGIN=12

  # --- Preheat (bed + nozzle to 150C for touch) ---
  SET_DISPLAY_TEXT MSG="Preheat: bed {target_bed} / noz 150"
  M140 S{target_bed}       ; bed target (no wait)
  M104 S145                ; nozzle to 150 (no wait)
  M190 S{target_bed}       ; wait bed
  M109 S145                ; ensure nozzle is exactly <=150 before touch steps

  # --- Homing / gantry leveling ---
  SET_DISPLAY_TEXT MSG="Homing..."
  G28

  SET_DISPLAY_TEXT MSG="Z tilt..."
  Z_TILT_ADJUST
  G28 Z

  # --- Mesh + Cartographer Touch (order is important) ---
  SET_DISPLAY_TEXT MSG="Bed mesh..."
  BED_MESH_CALIBRATE

  # --- Cartographer Touch Home ---
  SET_DISPLAY_TEXT MSG="Cartographer touch home..."
  M109 S150
  CARTOGRAPHER_TOUCH

  # --- Heat to print temp ---
  SET_DISPLAY_TEXT MSG="Heat nozzle {target_extruder}"
  G1 X{x_center} Y{y_center} Z15 F9000
  M109 S{target_extruder}

  # --- Prime line (moved to Y{y_prime}) ---
  SET_DISPLAY_TEXT MSG="Priming..."
  G92 E0
  G1 X{x_center - 50} Y{y_prime} Z0.40 F9000
  G1 X{x_center + 50} E18 F1000
  G92 E0

  LED_PRINTING
  SET_DISPLAY_TEXT MSG="Printing..."

[gcode_macro PRINT_END]
description: End-of-print: lift Z, park, turn off heaters/fans
variable_z_lift: 20.0
variable_park_margin: 5.0
gcode:
  SET_DISPLAY_TEXT MSG="Finishing..."
  M83

  {% set z_lift = printer["gcode_macro PRINT_END"].z_lift|float %}
  {% set m = printer["gcode_macro PRINT_END"].park_margin|float %}

  {% if "xyz" in printer.toolhead.homed_axes|lower %}
    {% set z_now = printer.toolhead.position.z|float %}
    {% set z_max = printer.toolhead.axis_maximum.z|float %}

    {% set z_up = z_lift %}
    {% if z_now + z_up > (z_max - 1.0) %}
      {% set z_up = (z_max - 1.0) - z_now %}
    {% endif %}
    {% if z_up < 0.0 %}
      {% set z_up = 0.0 %}
    {% endif %}

    G91
    G1 Z{z_up|round(3)} F3000
    G90

    {% set x_park = printer.toolhead.axis_minimum.x|float + m %}
    {% set y_park = printer.toolhead.axis_maximum.y|float - m %}
    G1 X{x_park|round(2)} Y{y_park|round(2)} F9000
  {% endif %}

  TURN_OFF_HEATERS
  M107
  M84
  SET_DISPLAY_TEXT MSG="Done."

[gcode_macro BEFORE_LAYER_CHANGE]
description: Called by slicer before each layer change (extensible)
variable_last_layer: -1
variable_last_z: -1.0
gcode:
  {% set layer = params.LAYER|default(-1)|int %}
  {% set z = params.Z|default(-1.0)|float %}

  # Сохраняем значения (потом сможете использовать в других макросах)
  SET_GCODE_VARIABLE MACRO=BEFORE_LAYER_CHANGE VARIABLE=last_layer VALUE={layer}
  SET_GCODE_VARIABLE MACRO=BEFORE_LAYER_CHANGE VARIABLE=last_z VALUE={z}

[gcode_macro AFTER_LAYER_CHANGE]
description: Called by slicer after each layer change (extensible)
variable_last_layer: -1
variable_last_z: -1.0
gcode:
  {% set layer = params.LAYER|default(-1)|int %}
  {% set z = params.Z|default(-1.0)|float %}

  # Сохранить значения для дальнейшего использования (можно расширять)
  SET_GCODE_VARIABLE MACRO=AFTER_LAYER_CHANGE VARIABLE=last_layer VALUE={layer}
  SET_GCODE_VARIABLE MACRO=AFTER_LAYER_CHANGE VARIABLE=last_z VALUE={z}

[gcode_macro BETWEEN_OBJECTS]
gcode:
  # Пока не используется

[gcode_macro FILAMENT_CHANGE]
description: Filament/Color change (main macro)
variable_z_lift: 20.0
variable_retract: 8.0
variable_park_x: 5.0
variable_park_y: 325.0
gcode:
  PAUSE
  M83
  G1 E-{printer["gcode_macro FILAMENT_CHANGE"].retract|float} F1800

  {% if "z" in printer.toolhead.homed_axes|lower %}
    G91
    G1 Z{printer["gcode_macro FILAMENT_CHANGE"].z_lift|float} F3000
    G90
  {% endif %}

  {% if "xy" in printer.toolhead.homed_axes|lower %}
    G1 X{printer["gcode_macro FILAMENT_CHANGE"].park_x|float} \
       Y{printer["gcode_macro FILAMENT_CHANGE"].park_y|float} F9000
  {% endif %}

# Алиас для совместимости со слайсерами (PrusaSlicer часто вставляет M600)
[gcode_macro M600]
description: Alias to FILAMENT_CHANGE for slicers
gcode:
  FILAMENT_CHANGE

# Очистка сопла
[gcode_macro CLEAN_NOZZLE]
description: Heat to 290/90, wipe at bed edge WITHOUT extrusion, snap string, cool with part fan, then disable fan and restore targets.
gcode:
  # --- Params / defaults ---
  {% set bed_clean = params.BED|default(90)|float %}
  {% set noz_clean = params.NOZZLE|default(290)|float %}
  {% set cool_noz  = params.COOL_NOZZLE|default(150)|float %}

  # Targets to restore for the rest of PRINT_START
  {% set target_bed = params.TARGET_BED|default(60)|float %}
  {% set target_noz = params.TARGET_NOZZLE|default(145)|float %}

  # Wipe geometry / motion
  {% set margin  = params.MARGIN|default(10.0)|float %}
  {% set y_off   = params.YOFF|default(2.0)|float %}         # distance from Y-min edge
  {% set z_wipe  = params.ZWIPE|default(0.35)|float %}        # Z height during wipe (tune!)
  {% set passes  = params.PASSES|default(6)|int %}            # number of wipe passes
  {% set wipe_f  = params.WIPE_F|default(3000)|int %}         # mm/min (wipe speed)

  {% set snap_moves = params.SNAP|default(10)|int %}          # quick moves to snap string
  {% set snap_dx = params.SNAP_DX|default(14.0)|float %}
  {% set snap_dy = params.SNAP_DY|default(8.0)|float %}
  {% set snap_f  = params.SNAP_F|default(12000)|int %}        # mm/min (snap speed)

  {% set home = params.HOME|default(1)|int %}

  SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE
  G90

  # --- Ensure homed (we will move at the bed edge) ---
  {% if home == 1 %}
    M118 CLEAN_NOZZLE: Homing...
    G28
  {% endif %}

  # --- Compute wipe line endpoints (front edge by default) ---
  {% set x0 = printer.toolhead.axis_minimum.x|float + margin %}
  {% set x1 = printer.toolhead.axis_maximum.x|float - margin %}
  {% set y  = printer.toolhead.axis_minimum.y|float + y_off %}
  {% if x1 <= x0 %}
    {action_raise_error("CLEAN_NOZZLE: X range too small (check MARGIN)")}
  {% endif %}

  # --- Lift before heating / travel ---
  G0 Z10 F3000

  # --- Heat bed + nozzle to cleaning temps (with wait) ---
  M118 CLEAN_NOZZLE: Heat bed {bed_clean}C / nozzle {noz_clean}C
  M140 S{bed_clean}
  M104 S{noz_clean}
  M190 S{bed_clean}
  M109 S{noz_clean}

  # --- Wipe at front edge (NO extrusion) ---
  M118 CLEAN_NOZZLE: Wipe passes={passes} Z={z_wipe}
  G0 X{x0} Y{y} Z{z_wipe} F9000
  {% for i in range(passes) %}
    G1 X{x1} F{wipe_f}
    G1 X{x0} F{wipe_f}
  {% endfor %}

  # --- Snap / drop residue: quick “flick” moves near the right end ---
  # Move slightly up so we don't gouge the plate during fast snaps
  G0 Z2.0 F6000
  {% for i in range(snap_moves) %}
    G0 X{x1}          Y{y}          F{snap_f}
    G0 X{x1 - snap_dx} Y{y + snap_dy} F{snap_f}
  {% endfor %}

  # Park safely
  G0 Z10 F3000

  # --- Cool down using part cooling fan, then disable it ---
  # M106/M107 are standard fan controls in Klipper. :contentReference[oaicite:1]{index=1}
  M118 CLEAN_NOZZLE: Cooling to {cool_noz}C (part fan ON)
  M106 S255
  M104 S{cool_noz}
  M109 S{cool_noz}
  M107

  # --- Restore targets for the rest of PRINT_START (no waits here) ---
  M140 S{target_bed}
  M104 S{target_noz}

  RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE
  M118 CLEAN_NOZZLE: Done

